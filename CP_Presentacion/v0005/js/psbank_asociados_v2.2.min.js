function iniciarDataTable(){tabla=objTabla.DataTable({pageLength:500,lengthMenu:[[500,1e3,2e3,-1],["500 Registros","1000 Registros","2000 Registros","Todos"]],dom:"Bfrtip",buttons:[{extend:"pageLength"},{extend:"csvHtml5",text:"CSV",exportOptions:{columns:[0,1,2,3,4,5,6,7,8,9]},title:function(){return nombreReporte}},{extend:"excelHtml5",text:"EXCEL",exportOptions:{columns:[0,1,2,3,4,5,6,7,8,9]},title:function(){return nombreReporte},sheetName:"Estados de Cuenta"}],language:{url:"bower_components/datatables-buttons/json/spanish.json",buttons:{pageLength:{_:"MOSTRAR %d REGISTROS","-1":"TODOS"}}},fnDrawCallback:function(){var n=objTabla.DataTable();n.data().length===0?n.buttons(".dt-button").disable():n.buttons(".dt-button").enable()},ordering:!1,bDestroy:!0,bDeferRender:!0,paging:!0,scrollY:$(document).height()-540+"px",scrollCollapse:!0,scroller:!0,bSort:!1,autoWidth:!0,responsive:!0,aoColumns:[{sWidth:"80px",sClass:"textoCentrado"},{sWidth:"110px",sClass:"textoCentrado"},null,null,null,null,{sWidth:"80px"},null,null,null,{bSortable:!1,sWidth:"40px"}]})}function agregarFilasDTAsociados(n){for(var i=[],t=0;t<n.length;t++)i.push([n[t].codigo,n[t].identificacion,n[t].nombre,n[t].centro,n[t].institucion,n[t].lugar_trabajo,n[t].provincia,n[t].canton,n[t].distrito,n[t].email,'<button type="button" id="'+n[t].identificacion+'" value="'+n[t].email+'" style="margin: 2px;" title="Enviar Email" class="btn btn-primary btn-enviar btn_datatable btn-xs"><i class="fa fa-envelope-o" aria-hidden="true"><\/i><\/button><button type="button" value="Eliminar" style="margin: 2px;" title="Eliminar" class="btn btn-danger btn-delete btn_datatable btn-xs"><i class="fa fa-minus" aria-hidden="true"><\/i><\/button>']);objTabla.dataTable().fnAddData(i)}function GenerarEstados(){var t=$("#tbl_asociados").DataTable(),i=t.rows().column(0).data().toArray(),u=t.rows().column(1).data().toArray(),r,n;i.length>0?(r=$("#txtFormato").val(),borrarDirectorio=$("#borrarDirectorio").is(":checked")?"S":"N",n={},n.codigos=i,n.cedulas=u,n.ruta=ruta,n.formato=r,n.id=cod_usuario,n.borrarDirectorio=borrarDirectorio,EjecutarGeneracionEstados(n)):(MsjTerminarEstados="No hay Estados de Cuenta para procesar!",tipoMsj="warning")}function EjecutarGeneracionEstados(n){parametrosGenerar=JSON.stringify(n);var t=(new Date).getTime();$.ajax({type:"POST",url:paginaUrl+"/GenerarEstados",data:parametrosGenerar,contentType:"application/json; charset=utf-8",dataType:"json",error:function(n,t,i){MensajeAlerta="Error: "+n.status+"<br>"+n.responseJSON.Message;"\n"+i;dialogoProgreso.progress(99);dialogoProgreso.hide();mensajeError(MensajeAlerta,paginaUrl);setTimeout(function(){window.location="./Login.aspx"},3e3)},success:function(n){var r=JSON.parse(n.d),t,i;$.each(r,function(n,r){t=r[0];i=r[1]});t==="0"?(MsjTerminarEstados=i,tipoMsj="success"):t==="1"?(MsjTerminarEstados=i,tipoMsj="warning"):t==="-1"&&(MsjTerminarEstados=i,tipoMsj="danger")}}).done(function(){dialogoProgreso.progress(99);dialogoProgreso.hide()}).done(function(){MensajeAlerta=MsjTerminarEstados;mensajeConfirm(MensajeAlerta,"Estados de Cuenta","material","green","fa-envelope")})}function EjecutarBusquedaAsociado(){var t=$("#txtBuscarAsociado").val(),n={};conEmail=$("#conEmail").is(":checked")?"S":"N";$("#txtBuscar").val()==="IDENTIFICACIÓN"?(n.identificacion=t,n.codigo="0"):(n.codigo=t,n.identificacion="0");n.cod_provincia="0";n.cod_canton="0";n.cod_distrito="0";n.cod_centro="0";n.cod_institucion="0";n.cod_lugar="0";n.con_email=conEmail;buscarAsociados(n,1)}function buscarAsociados(n,t){var i;if(!clic){clic=!0;i=n.identificacion==="0"?n.codigo:n.identificacion;n.ult_cod_cliente_gen=$("#chkUltimoCodCliente").is(":checked")&&$("#txtUltimoCodCliente").val()!==""?parseInt($("#txtUltimoCodCliente").val()):0;n.tipo_consulta="UNIFICADO";var r={},r=n,r={data:r};$.ajax({type:"POST",url:paginaUrl+"/CargarAsociados",data:JSON.stringify(r),contentType:"application/json; charset=utf-8",error:function(n,t,i){MensajeAlerta=n.status+"\n"+n.responseText;"\n"+i;mensajeError(MensajeAlerta,paginaUrl);animacion!==undefined&&setTimeout(function(){dialogoProgreso.hide();dialogoProgreso.stopAnimate(animacion)},500)},success:function(n){if(n.d.length===0)if(t===1){var r="";$("#conEmail").is(":checked")&&(r="Check solo con Email ACTIVO");Alerta("mensajeAlerta","No se encontró el Asociado: "+i+", "+r,"warning",2e3)}else Alerta("mensajeAlerta","No se encontraron Asociados!","warning",2e3);else agregarFilasDTAsociados(n.d)}}).done(function(){animacion!==undefined&&setTimeout(function(){dialogoProgreso.hide();dialogoProgreso.stopAnimate(animacion)},500);clic=!1})}}function mensajeEnvio(n,t,i,r,u,f,e,o,s,h,c,l,a,v){var p;p=n.length>500?"large":"medium";f=f===""?"Aceptar":f;e=e===""?"Está seguro de realizar esta acción ?":e;var w=r===""?"green":r,b=u===""?"fa-check-circle":u,y=i===""?"material":i;$.confirm({theme:y,title:t,content:n,columnClass:p,icon:"fa "+b,type:w,draggable:!0,dragWindowGap:0,animation:"scale",closeAnimation:"zoom",animationBounce:2.5,escapeKey:"cerrar",backgroundDismiss:!1,buttons:{confirm:{text:f,btnClass:"btn-primary",action:function(){if(emailEntrada=$("#emailAsociado").val(),emailEntrada)if(validarEmail(emailEntrada))$.confirm({theme:y,columnClass:"medium",type:w,title:"Confirmación de Envío",content:e+'<b class="text-danger">'+emailEntrada+"<\/b>.",icon:"fa fa-question-circle",animation:"scale",closeAnimation:"zoom",buttons:{confirm:{text:"Confirmar",btnClass:"btn-primary",action:function(){EnviarEstadoCuenta(l,a,v,emailEntrada,rutaEnvios)}},cancel:{text:"CANCELAR",btnClass:"btn-red",action:function(){mensajeConfirm(c,h,y,"blue","fa-warning")}}}});else return mensajeAlerta="Ingrese una dirección de correo valida!",t="Email Incorrecto",mensajeConfirm(mensajeAlerta,t,"material","red","fa-warning"),!1;else return $("#emailAsociado").focus(),!1}},cerrar:{text:"Cerrar",btnClass:"btn-red"}}})}function EnviarEstadoCuenta(n,t,i,r,u){var f={};f.codigo=n;f.cedula=t;f.nombre=i;f.email=r;f.ruta=u;f.id=cod_usuario;data=JSON.stringify(f);$.ajax({type:"POST",url:paginaUrl+"/EnviarEstadoCuenta",data:data,contentType:"application/json; charset=utf-8",error:function(n,t,i){MensajeAlerta="Error: "+n.status+"<br>"+n.responseJSON.Message;"\n"+i;mensajeError(MensajeAlerta,paginaUrl);setTimeout(function(){window.location="./Login.aspx"},3e3)},success:function(n){var r=JSON.parse(n.d),t,i;$.each(r,function(n,r){t=r[0];i=r[1]});t==="0"?(mensajeAlerta=mensajeExito+'<b class="text-danger">'+emailEntrada+"<\/b>.",titulo=i,mensajeConfirm(mensajeAlerta,titulo,"material","green","fa-envelope")):t==="-1"?(mensajeAlerta="Ocurrió un error. El estado de cuenta no se generó.",titulo=i,mensajeConfirm(mensajeAlerta,titulo,"material","red","fa-warning")):t==="-2"&&(mensajeAlerta="Ocurrió un error. El estado de cuenta no se envió.",titulo=i,mensajeConfirm(mensajeAlerta,titulo,"material","red","fa-warning"))}})}var paginaUrl="Estados_de_Cuenta.aspx",tabla,data,objTabla=$("#tbl_asociados"),inicio,ruta,rutaEnvios,animacion,MsjTerminarEstados,tipoMsj,conEmail,borrarDirectorio,nombreDirectorio,nombreReporte="Estados de Cuenta - Lista de Asociados",emailEntrada,mensajeAlerta,mensajeExito,tituloExito,clic=!1;$(document).ready(function(){iniciarDataTable();nombreDirectorio=formatDate(new Date)+"_GEN";login=$("#Login").val().trim();rutaEnvios=$("#ddlDisco").val()+"Estados\\"+login+"\\"+formatDate(new Date)+"_ENVIOS"});$(function(){function n(){var n={};conEmail=$("#conEmail").is(":checked")?"S":"N";n.cod_provincia=$("#ddlProvincia").val();n.cod_canton=$("#ddlCanton").val();n.cod_distrito=$("#ddlDistrito").val();n.cod_centro=$("#ddlCentro").val();n.cod_institucion=$("#ddlInstitucion").val();n.cod_lugar=$("#ddlLugarTrabajo").val();n.con_email=conEmail;n.codigo="0";n.identificacion="0";buscarAsociados(n,2)}$("#btnAgregar1").on("click",function(n){var t,i,r;n.preventDefault();t=$("#txtBuscarAsociado").val();t!==""&&(i=0,r=$("#txtBuscar").val()==="IDENTIFICACIÓN"?tabla.rows().column(1).data().toArray():tabla.rows().column(0).data().toArray(),i=jQuery.inArray(t,r),i===-1?EjecutarBusquedaAsociado():tabla.data().any()&&Alerta("mensajeAlerta","El Asociado ya existe en la Tabla!","warning",2e3))});$("#txtBuscarAsociado").on("keydown",function(n){var i=$("#txtBuscarAsociado").val(),r,t,u;i!==""&&(r=n.which,r===13&&(t=0,u=$("#txtBuscar").val()==="IDENTIFICACIÓN"?tabla.rows().column(1).data().toArray():tabla.rows().column(0).data().toArray(),t=jQuery.inArray(i,u),t===-1?EjecutarBusquedaAsociado():tabla.data().any()&&Alerta("mensajeAlerta","El Asociado ya existe en la Tabla!","warning",2e3)))});$("#btnAgregar2").on("click",function(t){t.preventDefault();dialogoProgreso.show('Cargando Asociados <span class="glyphicon glyphicon-hourglass"><\/span>');animacion=dialogoProgreso.animate();$("#ddlCentro").val()==="*"?$("#ddlCentro").focus():$("#ddlInstitucion").val()==="*"?$("#ddlInstitucion").focus():$("#ddlLugarTrabajo").val()==="*"?$("#ddlLugarTrabajo").focus():(objTabla.dataTable().fnClearTable(),n())});$("#txtDirectorio").on("input",function(){$("#txtDirectorio").val().includes(nombreDirectorio)?ruta=$("#ddlDisco").val()+"Estados\\"+login+"\\"+$("#txtDirectorio").val():$("#txtDirectorio").val(nombreDirectorio)});$("#btnModalGenerar").on("click",function(){var t=objTabla.DataTable().rows().count(),i="",n,r,u,f,e;$("#modalUbicacion").modal("hide");t>0?(t<38?(tiempoEstimado=t/1.6,i="Segundos"):(tiempoEstimado=t/38,i="Minutos"),n=Math.round(tiempoEstimado*100)/100,r=i==="Minutos"?Math.round(n*60)*1e3:Math.round(n)*1e3,u="Procesando "+t+' registros en <span class="glyphicon glyphicon-hourglass"><\/span>'+n+" "+i,dialogoProgreso.show(u,{dialogSize:"m",progressType:"info"}),dialogoProgreso.progress(0),ruta=$("#ddlDisco").val()+"Estados\\"+login+"\\"+$("#txtDirectorio").val(),f="Ir a: \\\\Omega\\Estados\\"+login+"\\"+$("#txtDirectorio").val()+" ",e=[{msj:"Espere un momento por favor",prog:1},{prog:2},{prog:4},{prog:6},{prog:8},{prog:10},{prog:12},{prog:14},{prog:16},{prog:18},{msj:"Ruta : "+ruta+"",prog:20},{prog:22},{prog:24},{prog:26},{prog:28},{msj:"Descargando estados",prog:30},{prog:32},{prog:34},{prog:36},{prog:38},{msj:"Ruta : "+ruta+"",prog:40},{prog:42},{prog:44},{prog:46},{prog:48},{prog:50},{prog:52},{prog:54},{prog:56},{prog:58},{prog:60},{prog:62},{prog:64},{prog:66},{prog:68},{prog:70},{prog:72},{prog:74},{prog:76},{prog:78},{prog:80},{prog:82},{prog:84},{prog:86},{prog:88},{prog:90},{prog:91},{prog:92},{prog:93},{prog:94},{prog:95},{prog:96},{prog:97},{prog:98},{msj:f,prog:98}],e.forEach(function(t){setTimeout(function(){var r,u,f;t.msj?(r=t.msj+"   "+t.prog.toString()+"%",dialogoProgreso.mensaje(r)):(u=n-n*(t.prog/100),f='Tiempo estimado: <span class="glyphicon glyphicon-hourglass"><\/span>'+Math.round(u*100)/100+" "+i,dialogoProgreso.mensaje(f+"   "+t.prog.toString()+"%"));dialogoProgreso.progress(t.prog)},r*(t.prog/100))}),GenerarEstados()):(MsjTerminarEstados="No hay Estados de Cuenta para procesar!",tipoMsj="warning",Alerta("mensajeAlerta",MsjTerminarEstados,tipoMsj,3e3))})});$(function(){$("#btnLimpiarTabla").on("click",function(n){n.preventDefault();objTabla.dataTable().fnClearTable()});$("#chkUltimoCodCliente").on("ifChanged",function(){$("#chkUltimoCodCliente").is(":checked")?$("#txtUltimoCodCliente").prop("disabled",!1):$("#txtUltimoCodCliente").prop("disabled",!0)})});$(document).on("click",".btn-delete",function(n){n.preventDefault();var t=$("#tbl_asociados").DataTable(),i=$(this).parent().parent()[0];t.row(i).remove().draw()});$(document).on("click",".btn-enviar",function(n){n.preventDefault();var f=$(this).parent().parent()[0],t=objTabla.fnGetData($(f)),e=t[0],r=t[1],u=t[9],o=t[4],i=t[2];mensaje=' <form action="" class="formName"> <div class="form-group"> <p> Se enviará el estado de cuenta del asociado seleccionado al correo que aparece registrado en <b> PSBANKER <\/b>, si lo requiere puede cambiar la dirección de correo.<br> <b class="text-danger">( El cambio de correo NO afecta los datos de PSBANKER )<\/b>.<br><br> <b> Institución: <\/b>'+o+"<br> <b> Cédula: <\/b>"+r+"<br> <b> Nombre: <\/b>"+i+'<br> <b> Correo: <\/b> <input style="width:300px;" type="email" id="emailAsociado" value="'+u+'" /><br> <\/p> <\/div> <\/form>';titulo="Envío de Estado de Cuenta";tema="material";tipo="blue";icono="fa-envelope";tituloConfirmacion="Enviar";mensajeConfirma="Está seguro que desea enviar el estado de cuenta del asociado <b>"+i+"<\/b> al correo ";tituloExito="Enviado con Éxito";mensajeExito="Estado de cuenta <b>Enviado<\/b> al correo: ";tituloCancel="Envío Cancelado";mensajeCancel="El envío há sido <b> Cancelado<\/b >.";mensajeEnvio(mensaje,titulo,tema,tipo,icono,tituloConfirmacion,mensajeConfirma,tituloExito,mensajeExito,tituloCancel,mensajeCancel,e,r,i,u)});